<form *ngIf='data' #citationForm='ngForm' (submit)='save(citationForm.value)'>
   <div class='row'>
      <div class='col-md-12 form-group floatlabel'>
         <floatlabelinput [(ngModel)]='data.source.title' name='title' [readonly]='data.source.medium!=""' label='Full Citation' [title]='citation?.template?.full' required #full='ngModel'></floatlabelinput>
         <div [hidden]='full.valid||full.pristine' class='alert alert-danger'>Must be specified</div>
      </div>

      <div class='col-md-12 form-group floatlabel'>
         <floatlabelinput [(ngModel)]='data.source.abbrev' name='abbrev' [readonly]='data.source.medium!=""' label='Short Citation' [title]='citation?.template?.abbrev'></floatlabelinput>
      </div>

      <div class='col-md-12 form-group floatlabel'>
         <floatlabelinput [(ngModel)]='data.source.biblio' name='biblio' [readonly]='data.source.medium!=""' label='Bibliography Citation' [title]='citation?.template?.biblio'></floatlabelinput>
      </div>
   </div>

   <h4>Citation Details</h4>
   <div class='row'>
      <div class='col-md-12 form-group floatlabel'>
         <select
            name='medium'
            class='form-control nonempty'
            [ngModel]='data.source.medium'
            (ngModelChange)='onMediumChange($event)'
            title='Select the type of source. This will change the details below to those needed for proper citation'>
            <option value=''>Select citation template</option>

            <optgroup [label]="g.name" *ngFor='let g of source_types | groupBy:"category"'>
               <option *ngFor='let opt of g' [value]='opt.id'>{{opt.type}}</option>
            </optgroup>
         </select>
      </div>

      <div class='col-md-12 form-group' *ngIf='citation'>
         <floatlabelinput *ngFor='let p of citation.fields'
            [ngModel]='cache[p]' (ngModelChange)='computeCitation(p,$event)'
            [name]='p'
            [label]='p'></floatlabelinput>
      </div>

      <!-- Should select whether this is a primary source,... (or
      original/derivative although this distinction is sometimes
      better left for each evidence/pieces of info found in this
      source.  See QuickLesson 2 from Elizabeth Shown Mill's website.
      Evidence is our interpretation of the pieces of information -->

   </div>

   <h4>Higher-level sources</h4>
   <div class='row'>
      <div class='col-md-12'>
         <ul *ngIf='data.higherSources'>
            <li *ngFor='let h of data.higherSources'>
               <source-link [id]='h.id' [name]='h.title' [title]='h.title'></source-link>
            </li>
         </ul>
         <floatlabelinput [(ngModel)]='data.source.higher_source_id'
             name='higher_source_id'
             title='Select the source in which this one was found, for instance a specific will inside a will book'
             label='Parent source'></floatlabelinput>
      </div>
   </div>

   <h4 *ngIf='extra_parts.length>0'>Extra Details</h4>
   <div class='row' *ngIf='extra_parts.length>0'>
      <div class='col-md-12'>
         The following information is stored in the database, but not
         needed for the citation templates (perhaps imported from GEDCOM).
      </div>
      <div class='col-md-12 form-group'>
         <floatlabelinput *ngFor='let p of extra_parts'
            [ngModel]='p.value' (ngModelChange)='onExtraPartChange(p,$event)'
            [name]='p.name'
            [label]='p.name'></floatlabelinput>
      </div>
   </div>

   <!-- Details common to all sources, needed by the GenTech data model -->

   <h4>Research Details</h4>
   <div class='row'>
      <div class='col-md-12 form-group'>
         <floatlabelinput [(ngModel)]='data.source.subject_date_id'
              title="The date the source is about. This isn't the date of the source itself."
              name='subject_date'
              label='Subject date'></floatlabelinput>

         <floatlabelinput [(ngModel)]='data.source.subject_place_id'
              title="The place that the source is about"
              name='subject_place'
              label='Subject place'></floatlabelinput>

         <floatlabelinput [(ngModel)]='data.source.jurisdiction_place_id'
              title='Where the source was found'
              name='jurisdiction_place'
              label='Jurisdiction place'></floatlabelinput>

         <floatlabelinput
              ngModel='{{data.source.researcher.name}} (changed on {{data.source.last_change}})'
              readonly='true'
              [ngModelOptions]='{standalone:true}'
              label='Researched by'></floatlabelinput>

         <floatlabelinput [(ngModel)]='data.source.comments'
              name='comments' label='Notes' lines=5></floatlabelinput>
      </div>
   </div>

   <button class='btn btn-primary center-block' type='submit'
      *ngIf='!citationForm.pristine || data.source.id==null'
      [disabled]='!citationForm.valid'>{{data.source.id==null ? "Create" : "Save"}}</button>
</form>
