<form #spy2>
   form={{spy2.className}}
   <input class='form-control' required name='foo' [(ngModel)]='data.foo' #spy>
   <div [hidden]='spy.valid || spy.pristine' class='alert alert-danger'>Value is required</div>
   input={{spy.className}}
</form>
<form *ngIf='data' #citationForm='ngForm'>
   <h4>Citation</h4>
   <div class='row'>
      <div class='col-md-12 form-group floatlabel'>
         <floatlabelinput [(modelpath)]='data.source.title' [readonly]='data.source.medium!=""' label='Full Citation' [title]='citation?.template?.full'></floatlabelinput>
      </div>

      <div class='col-md-12 form-group floatlabel'>
         <floatlabelinput [(modelpath)]='data.source.abbrev' [readonly]='data.source.medium!=""' label='Short Citation' [title]='citation?.template?.abbrev'></floatlabelinput>
      </div>

      <div class='col-md-12 form-group floatlabel'>
         <floatlabelinput [(modelpath)]='data.source.biblio' [readonly]='data.source.medium!=""' label='Bibliography Citation' [title]='citation?.template?.biblio'></floatlabelinput>
      </div>
   </div>

   <h4>Citation Details</h4>
   <div class='row'>
      <div class='col-md-12 form-group floatlabel'>
         <select id='_sourceType'
            class='form-control nonempty'
            [ngModel]='data.source.medium'
            (ngModelChange)='onMediumChange($event)'
            title='Select the type of source. This will change the details below to those needed for proper citation'>
            <option value=''>Select citation template</option>

            <optgroup [label]="optlist[0].category" *ngFor='let optlist of source_types | groupBy:"category"'>
               <option *ngFor='let opt of optlist' [value]='opt.id'>{{opt.type}}</option>
            </optgroup>
         </select>

         <label>Source Type</label>
      </div>

      <div class='col-md-12 form-group' *ngIf='citation'>
         <floatlabelinput *ngFor='let p of citation.fields'
            [modelpath]='cache[p]' (modelpathChange)='computeCitation(p,$event)'
            [label]='p'></floatlabelinput>
      </div>

      <!-- Should select whether this is a primary source,... (or
      original/derivative although this distinction is sometimes
      better left for each evidence/pieces of info found in this
      source.  See QuickLesson 2 from Elizabeth Shown Mill's website.
      Evidence is our interpretation of the pieces of information -->

   </div>

   <h4>Higher-level sources</h4>
   <div class='row'>
      <div class='col-md-12'>
         <ul *ngIf='data.higherSources'>
            <li *ngFor='let h of data.higherSources'>
               <source-link [id]='h.id' [name]='h.title' [title]='h.title'></source-link>
            </li>
         </ul>
         <floatlabelinput [(modelpath)]='data.source.higher_source_id'
             size=6 
             title='Select the source in which this one was found, for instance a specific will inside a will book'
             label='Parent source'></floatlabelinput>
      </div>
   </div>

   <h4 *ngIf='extra_parts.length>0'>Extra Details</h4>
   <div class='row' *ngIf='extra_parts.length>0'>
      <div class='col-md-12'>
         The following information is stored in the database, but not
         needed for the citation templates (perhaps imported from GEDCOM).
      </div>
      <div class='col-md-12 form-group'>
         <floatlabelinput *ngFor='let p of extra_parts'
            [modelpath]='p.value' (modelpathChange)='onExtraPartChange(p,$event)'
            [label]='p.name'></floatlabelinput>
      </div>
   </div>

   <!-- Details common to all sources, needed by the GenTech data model -->

   <h4>Research Details</h4>
   <div class='row'>
      <div class='col-md-12 form-group'>
         <floatlabelinput [(modelpath)]='data.source.subject_date_id'
              title="The date the source is about. This isn't the date of the source itself."
              label='Subject date'></floatlabelinput>

         <floatlabelinput [(modelpath)]='data.source.subject_place_id'
              title="The place that the source is about"
              label='Subject place'></floatlabelinput>

         <floatlabelinput [(modelpath)]='data.source.jurisdiction_place_id'
              title='Where the source was found'
              label='Jurisdiction place'></floatlabelinput>

         <floatlabelinput
              modelpath='{{data.source.researcher.name}} (changed on {{data.source.last_change}})'
              readonly='true'
              label='Researched by'></floatlabelinput>

         <floatlabelinput [(modelpath)]='data.source.comments'
              label='Notes' lines=5></floatlabelinput>
      </div>
   </div>

   {{citationForm|json}}

   <button class='btn btn-primary center-block'
      *ngIf='citationForm.dirty || data.source.id==null'
      (click)='saveParts()'>{{data.source.id==null ? "Create" : "Save"}}</button>
</form>
