<div class='row'>

   <div class='col-md-12'>
      <div class='panel panel-default'>
         <div class='panel-heading editable-title' ng-click='showCitation=!showCitation'>
            <span class='fa fa-pencil editable-title' ng-bind-html='source.title'></span>
         </div>
         <div class='panel-body' ng-if='showCitation'>
            <form name='citationForm'>
               <h4>Citation</h4>
               <div class='row'>
                  <div class='col-md-12 form-group floatlabel'>
                     <span ng-bind-html='source.title' class='form-control nonempty' readonly ng-if='source.medium' title='{{citation.full}}'></span>
                     <input ng-model='source.title' class='form-control nonempty' ng-if='!source.medium'></input>
                     <label>Full Citation</label>
                  </div>

                  <div class='col-md-12 form-group floatlabel'>
                     <span ng-bind-html='source.abbrev' class='form-control nonempty' readonly ng-if='source.medium' title='{{citation.abbrev}}'></span>
                     <input ng-model='source.abbrev' class='form-control nonempty' ng-if='!source.medium'></input>
                     <label>Short Citation</label>
                  </div>

                  <div class='col-md-12 form-group floatlabel'>
                     <span ng-bind-html='source.biblio' class='form-control nonempty' readonly ng-if='source.medium' title='{{citation.biblio}}'></span>
                     <input ng-model='source.biblio' class='form-control nonempty' ng-if='!source.medium'></input>
                     <label>Bibliography Citation</label>
                  </div>

                  <div gp-float-label model='source.higher_source_id'
                       title='Select the source in which this one was found, for instance a specific will inside a will book'
                       label='Parent source'></div>
                  <span source-link='source.higher_source_id'></span>
               </div>

               <h4>Citation Details</h4>
               <div class='row'>
                  <div class='col-md-12 form-group floatlabel'>
                     <select id='_sourceType'
                        class='form-control nonempty'
                        title='Select the type of source. This will change the details below to those needed for proper citation'
                        ng-options='opt.id as opt.type group by opt.category for opt in source_types'
                        ng-model='source.medium'>
                     </select>
                     <label>Source Type</label>
                  </div>

                  <div gp-float-label ng-repeat='p in citation.fields' model='cache[p]'
                       label='{{p}}'></div>

                  <!-- Should select whether this is a primary source,... (or
                  original/derivative although this distinction is sometimes
                  better left for each evidence/pieces of info found in this
                  source.  See QuickLesson 2 from Elizabeth Shown Mill's website.
                  Evidence is our interpretation of the pieces of information -->

               </div>

               <div ng-if='extra_parts.length>0'>
                  <h4>Extra Details</h4>
                  <p>The following information is stored in the database, but not
                     needed for the citation templates (perhaps imported from GEDCOM).</p>
                  <div class='row'>
                      <div gp-float-label ng-repeat='p in extra_parts' model='p.value'
                           label='{{p.name}}'></div>
                  </div>
               </div>

               <!-- Details common to all sources, needed by the GenTech data model -->

               <h4>Research Details</h4>
               <div class='row'>
                  <div gp-float-label model='source.subject_date_id'
                       title="The date the source is about. This isn't the date of the source itself."
                       label='Subject date'></div>

                  <div gp-float-label model='source.subject_place_id'
                       title="The place that the source is about"
                       label='Subject place'></div>

                  <div gp-float-label model='source.jurisdiction_place_id'
                       title='Where the source was found'
                       label='Jurisdiction place'></div>

                  <div class='col-md-6 form-group floatlabel'>
                     <input readonly class='nonempty form-control' value="{{source.researcher.name}} (changed on {{source.last_change | date}})"/>
                     <label>Researched by</label>
                  </div>

                  <div gp-float-label model='source.comments' label='Notes' size=12 lines=5></div>

               </div>

               <button class='btn btn-primary center-block' ng-if='citationForm.$dirty || source.id<0' ng-click='saveParts()'>{{source.id>=0? "Save" : "Create"}}</button>
            </form>
         </div>
      </div>
   </div>

   <!-- The media for the source -->
   <div class='col-md-12'>
      <div class='panel panel-default'>
         <div class='panel-heading'>
            Media

            <!-- Selecting the media -->

            <span style='margin-left: 30px' ng-if='repr.length!=0'>
               <button class='btn btn-xs btn-default fa fa-backward' ng-click='prevImage()' ng-disabled='current_repr==0'></button>
               {{current_repr + 1}} / {{repr.length}}
               <button class='btn btn-xs btn-default fa fa-forward' ng-click='nextImage()' ng-disabled='current_repr==repr.length - 1'></button>
            </span>

            <!-- Image operations -->
            <span style='margin-left: 30px' ng-if='repr.length!=0'>
               <button class='btn btn-xs btn-default fa fa-search-minus' ng-click='img.zoomOut()' title='alt-wheel to zoom interactively'></button>
               <button class='btn btn-xs btn-default fa fa-square-o' ng-click='img.fit()' title='Fit image'></button>
               <button class='btn btn-xs btn-default fa fa-search-plus' ng-click='img.zoomIn()' title='alt-wheel to zoom interactively'></button>
            </span>

            <!-- Media operations -->
            <span style='margin-left: 30px' ng-if='repr.length!=0'>
               <button class='btn btn-xs btn-default fa fa-trash' ng-click='deleteCurrentRepr()' title='Delete the image'></button>
            </span>

            <!-- Adding new images -->

            <span class='nav navbar-nav navbar-right' gp-upload-target url='/data/sources/{{source.id}}/addRepr' onupload='onupload()' autosubmit=1>
               <span gp-download-form-mini></span>
            </span>

         </div>

         <!-- Image representation or Adding new media -->
         <!-- The whole area is a drop target for adding new media -->

         <div class='panel-body' gp-upload-target url='/data/sources/{{source.id}}/addRepr' onupload='onupload()' autosubmit=1>
            <div gp-download-form ng-if='repr.length==0'></div>
            <figure ng-if='repr.length!=0'>
               <span zoom-image src='repr[current_repr].url' image='img'></span>
               <figcaption>{{repr[current_repr].comments}}</figcaption>
            </figure>
         </div>
      </div>
   </div>

   <!-- The assertions for the source -->
   <div class='col-md-12' ng-if="asserts.length>0">
      <div class='panel panel-default'>
         <div class='panel-heading'>Assertions</div>
         <div class='panel-body'>
            <div ng-repeat='a in asserts' ng-class='{disproved: a.disproved}'
                  class='clearfix' style='margin-bottom: 20px'>
               <!-- General info -->

               <span class='researchedBy'>
                  researched by {{a.researcher.name}} ({{a.last_change|date}})
               </span>
               <span gp-surety='a.surety' style='float:right'></span>

               <!-- P2... -->

               <span persona-link='a.person1.id' name='a.person1.name' ng-if='a.person1'></span>
               <br>

               <!-- P2P -->

               <span persona-link='a.person2.id' name='a.person2.name' ng-if='a.person2'></span>

               <!-- P2E -->

               <span ng-if='a.event2'>
                  <span>
                     {{a.event2.type.name}}
                     <span ng-if='a.role != "principal"' class='role'>(as {{a.role || ''}})</span>
                  </span>
                  <br>
                  <span time-link='a.event2.date_sort' name='a.event2.date' style='margin-right:10px'></span>
                  <span place-link='a.event2.place.id' name='a.event2.place.name'></span>
               </span>

               <!-- P2C -->

               <span ng-if='a.char2'>
                  {{a.char2.name}}
                  <span ng-if='a.char_parts2.length == 1'>
                     : {{a.char_parts2[0].value}}
                  </span>
                  <span ng-if='a.char_parts2.length != 1'>
                     <span ng-repeat='p in a.char_parts2'>
                        <span class="char">{{p.name}}</span>: {{p.value}}<br>
                     </span>
                  </span>
                  <br>
                  <span time-link='a.char2.date_sort' name='a.char2.date' style='margin-right:10px'></span>
                  <span place-link='a.char2.place.id' name='a.char2.place.name'></span>
               </span>

               <!-- P2G -->

               <span ng-if='a.group2'>
                  {{a.group2.name}} ({{a.role}})
                  <br>
                  <span time-link='a.group2.date_sort' name='a.group2.date' style='margin-right:10px'></span>
                  <span place-link='a.group2.place.id' name='a.group2.place.name'></span>
               </span>

               <!-- Rationale -->

               <br>
               {{a.rationale}}
              </div>
            </div>
         </div>
      </div>
   </div>
</div>
