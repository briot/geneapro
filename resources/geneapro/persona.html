{% extends "geneapro/base.html" %}
{% block title %}GeneaPro: person {{decujus.id}}{% endblock %}
{% block css %}
.pedigree td.indiv {background:url({{MEDIA_URL}}horiz.png) left center no-repeat}
{% endblock css %}

{% block header %}
<link rel="stylesheet" href="{{MEDIA_URL}}datatables.css"/>
<script type="text/javascript" src="{{MEDIA_URL}}jquery.raty.min.js"></script>
{% endblock header %}

{% block script %}

var schemes = {
{% for i, s in schemes.items %}
  {{i}}: [
  {% for p in s %}
    '{{p.name}}',
  {% endfor %}
  ],
{% endfor %}
};


$(document).ready(function() {

$(".surety").each(function() {
  var $t=$(this), val=$t.attr("_order"), s=$t.attr("_scheme");
  $t.empty().raty({
     path:'{{MEDIA_URL}}raty_img/',
     number:schemes[s].length,
     hintList: schemes[s],
     start:val,
     cancel:true,
     cancelHint:'Unknown surety',
     readOnly:true,
     })
  });


$("#list").dataTable(
  {"bPaginate": false,
   "sDom": '<"top"fi>rt',
   "aaSorting": [[ 3, "asc" ]], // initial sort on dates
   "aoColumns": [
      { "bSortable":false },
      null,
      null,
      { "iDataSort":4},    //  3: date
      { "bVisible":false}, //  4: sortDate
      null,
      null,
      null,
      null,
      null,
   ],
  }
);
});

{% endblock script %}

{% block endbody %}
{% endblock endbody %}

{% block leftside %}
{% endblock leftside %}

{% block contents %}

<h3 id="title">
   <span class="id">{{decujus.id}}</span>
   <span class="givenName">{{decujus.base_given_name}}</span>
   <span class="surName">{{decujus.base_surname}}</span>
   <span class="details">({{decujus.birth.date}} - {{decujus.death.date}})</span>
</h3>

<div id="containers">
 <table id="list" class="persona">
   <thead>
      <tr>
         <th>Type (Role)</th>
         <th>Name</th>
         <th>Date</th>
         <th>sortDate</th>
         <th>Place</th>
         <th>Comment</th>
         <th>Persona</th>
         <th>Sources</th>
         <th>Surety</th>
      </tr>
   </thead>
   <tbody>

   {% for k, c in chars.items %}
   <tr>
      <td>{{c.char.name}}</td>

      {% if c.parts|length == 1 %}
      <td>{{c.parts.0.value}}</td>
      {% else %}
      <td>
         {% for p in c.parts %}
         <span class="char">{{p.name}}</span>: {{p.value}}<br>
         {% endfor %}
      </td>
      {% endif %}

      <td class="date">{{c.char.Date|default:""}}</td>
      <td>{{c.char.date_sort|date:"c"}}</td>
      <td class="place">{{c.char.place|default:""}}</td>
      <td class="assert">
         {{c.assertion.value|linebreaks}}
         {{c.assertion.rationale|default:""|linebreaks}}
      </td>
      <td class="persona">{{c.assertion.person_id}}</td>
      <td>
         {% for s in c.char.sources %}
            {% if s %}
         <a href="/sources/{{s}}">{{s}}</a>
            {% endif %}
         {% endfor %}
      </td>
      <td class="surety" id="csurety{{k}}"
          _scheme="{{c.assertion.surety.scheme_id}}"
          _order="{{c.assertion.surety.sequence_number}}"/>
   </tr>
   {% endfor %}

   {% for i, e in events.items %}
      {% if e.assertion.disproved %}
      <tr class="disproved">
      {% else %}
      <tr>
      {% endif %}
         {% if e.role == "principal" %}
         <td>{{e.event.type.name}}</td>
         {% else %}
         <td>{{e.event.type.name}} ({{e.role|default:""}})</td>
         {% endif %}
         <td>{{e.event.name}}</td>
         <td class="date">{{e.event.Date|default:""}}</td>
         <td>{{e.event.date_sort|date:"c"}}</td>
         <td class="place">{{e.event.place|default:""|linebreaks}}</td>
         <td class="assert">
            {{e.assertion.value|linebreaks}}
            {{e.assertion.rationale|default:""|linebreaks}}
         </td>
         <td class="persona">{{e.assertion.person_id}}</td>
         <td>
            {% for s in e.event.sources %}
               {% if s %}
             <a href="/sources/{{s}}">{{s}}</a>
               {% endif %}
            {% endfor %}
         </td>
         <td class="surety" id="esurety{{i}}"
             _scheme="{{e.assertion.surety.scheme_id}}"
             _order="{{e.assertion.surety.sequence_number}}"/>
      </tr>
   {% endfor %}

   {% for i, g in groups.items %}
      <tr>
         <td>Group</td>
         <td>{{g.group.name}} ({{g.group.role|default:""}})</td>
         <td class="date">{{g.group.date|default:""}}</td>
         <td>{{g.group.date_sort|date:"c"}}</td>
         <td class="place">{{g.group.place|default:""}}</td>
         <td class="assert">
            {{g.assertion.value|linebreaks}}
            {{g.assertion.rationale|default:""|linebreaks}}
         </td>
         <td class="persona">{{g.assertion.person_id}}</td>
         <td>
            {% for s in g.group.sources %}
               {% if s %}
            <a href="/sources/{{s}}">{{s}}</a>
               {% endif %}
            {% endfor %}
         </td>
         <td class="surety" id="gsurety{{i}}"
             _scheme="{{g.assertion.surety.scheme_id}}"
             _order="{{g.assertion.surety.sequence_number}}"/>
      </tr>
   {% endfor %}
   </tbody>
 </table>

 {% if p2p|length %}
 <p class="onUse" style="margin-top:10px">
 This person is made up of several persona in the database. Each of
 these persona was constructed from one or more sources, and then they
 were all linked together with the following assertions. Disproving any
 of these will change the information displayed above.
 </p>

 <table>
   <thead>
      <tr>
         <th>Persona1</th>
         <th>Persona2</th>
         <th>These are the same because</th>
         <th>Comments</th>
         <th>Surety</th>
      </tr>
   </thead>
   <tbody>
      {% for p in p2p %}
        {% if p.1.person1_id != p.1.person2_id %}
          {% if p.1.disproved %}
      <tr class="disproved">
          {% else %}
      <tr>
          {% endif %}
        {# ??? Should we show sources and researcher #}
        <td class="persona">{{p.1.person1_id}}</td>
        <td class="persona">{{p.1.person2_id}}</td>
        <td>{{p.1.rationale|default:""}}</td>
        <td>{{p.1.value|default:""}}</td>
        <td class="surety" id="asurety{{forloop.counter}}"
                  _scheme="{{p.1.surety.scheme_id}}"
                  _order="{{p.1.surety.sequence_number}}"/>
        </td>
     </tr>
        {% endif %}
      {% endfor %}
   </tbody>
 </table>
 {% endif %}  {# p2p|length #}

</div>
{% endblock contents %}

