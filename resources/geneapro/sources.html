{% extends "geneapro/base.html" %}
{% block title %}GeneaPro: source {{s.id}} {% endblock %}
{% block css %}
{# Defined in line to get variable replacement #}
{#
.jcarousel-skin-tango .jcarousel-next-horizontal {background: transparent url({{MEDIA_URL}}next-horizontal.png) no-repeat 0 0}
.jcarousel-skin-tango .jcarousel-prev-horizontal {background: transparent url({{MEDIA_URL}}prev-horizontal.png) no-repeat 0 0}
.sourceGallery ul.carousel li {background:url({{MEDIA_URL}}entry.gif) 0 0 no-repeat}
#}
{% endblock css %}

{% block less %}
<link rel="stylesheet/less" href="{{MEDIA_URL}}datatables.less"/>
{# <link rel="stylesheet/less" href="{{MEDIA_URL}}jcarousel.less"/> #}
{% endblock less %}

{% block header %}
<link rel="stylesheet" href="{{MEDIA_URL}}ui.tabs.css"/>
<script type="text/javascript" src="{{MEDIA_URL}}jquery.dragpane.js"></script>
<script type="text/javascript" src="{{MEDIA_URL}}mouse_events.js"></script>
<script type="text/javascript" src="{{MEDIA_URL}}gallery.js"></script>
<script type="text/javascript" src="{{MEDIA_URL}}jquery.sprintf.js"></script>
{% endblock header %}

{% block contents %}
<div id="sourceDetails">
   <div id="sourceInfo">
      <span class="id">Source {{s.id}}</span>
      <span class="name">
      {% if s.title %}
         {{s.title}}
      {% else %}
         {% if s.abbrev %}
         {{s.abbrev}}
         {% else %}
         {{s.comments}}
         {% endif %}
      {% endif %}
       </span>
      <div class="moreInfo">
         <div class="arrow" title="Edit source citation"></div>
         <div class="details">
            <fieldset>
               <legend>Citation (parent citation grayed out)</legend>
               <input type="button"
                      value="Set parent"
                      title="Select the source in which this one was found, for instance a specific will inside a will book"/>

               <span class="field sourceMediaType">
                  <label for="_sourceMediaType">Source type</label>
                  <select name="sourceMediaType" id="_sourceMediaType"
                          title="Select the type of source. This will change the details below to collect those needed for proper citation">
                      <option selected>{{c.medium.name|default:"unknown"}}</option>
                      {% for t in source_mediums %}
                      <option>{{t.name}}</option>
                      {% endfor %}
                  </select>
               </span>

               {#??? Should select whether this is a primary source,... (or original/derivative #}
               {# although this distinction#}
               {# is sometimes better left for each evidence/pieces of info found in this source. #}
               {# See QuickLesson 2 from Elizabeth Shown Mill's website #}
               {# Evidence is our interpretation of the pieces of information #}

               <div style="clear:both"></div>
               <div style="margin-left: 0px;">
                  {% for c in s.citations %}
                  <span class="field disabled">
                     <label for="_{{c.type.name}}">{{c.type.name}}</label>
                     <input disabled type="text" id="_{{c.type.name}}" value="{{c.value}}"/>
                  </span>
                  {% endfor %}

                  {# Below are field that would be displayed depending on source type #}
                  {# and what is needed to make up the citation #}
                  <span class="field">
                     <label for="_publication">Publication date</label>
                     <input type="text" id="_publication" name="publication" value=""/>
                  </span>
                  <span class="field">
                     <label for="_volume">Volume</label>
                     <input type="text" id="_volume" name="volume" value=""/>
                  </span>
                  <span class="field">
                     <label for="_page">Page</label>
                     <input type="text" id="_page" name="page" value=""/>
                  </span>
               </div>
            </fieldset>

            {# The details common to all sources, needed by the GenTech data model #}
            <fieldset>
               <legend>Research details</legend>
               <span class="field">
                  <label for="_subjectDate">Subject date</label>
                  <input type="text" id="_subjectDate" class="date"
                         title="The date the source is about. This isn't the date of the source itself."
                         value="{{s.subject_date|default:""}}"/>
               </span>
               <span class="field">
                  <label for="_subjectPlace">Subject place</label>
                  <input type="text" id="_subjectPlace"
                         title="The place the source is about"
                         value="{{s.subject_place|default:""}}"/>
               </span>
               <span class="field">
                  <label for="_jurisdictionPlace">Jurisdiction place</label>
                  <input type="text" id="_jurisdictionPlace"
                         title="Where the source was found"
                         value="{{s.jurisdiction_place|default:""}}"/>
               </span>
               <span class="field">
                  <label for="_researcher">Researched by</label>
                  <input type="text" id="_researcher" value="{{s.researcher.name}}"/>
               </span>
               <span class="field">
                  <label for="_notes">Notes</label>
                  <textarea id="_notes" name="notes">{{s.comments}}</textarea>
               </span>
            </fieldset>

            {# The repositories #}
            <fieldset>
               <legend>Repositories</legend>
               <div class="actions"> 
                  <input type="button" value="+"/>
                  <input type="button" value="-"/>
               </div>
               {% for r in s.repositories.all %}
               <div class="repositoryInfo">
                  <div class="fieldGroup">
                     <span class="field">
                        <label for="_repoName1">Name</label>
                        <input type="text" id="_repoName1" value="{{r.name}}"
                               title="A repository is a physical (or Internet) location where the source was found. It will in general give access to several sources">
                     </span>
                     <span class="field">
                        <label for="_repoType1">Type</label>
                        <select name="repositoryType">
                            {% for t in repository_types %}
                            <option>{{t.name}}</option>
                            {% endfor %}
                        </select>
                     </span>
                  </div>
                  <span class="field">
                     <label for="_repoAddr1">Address/URL</label>
                     <textarea lines="3">{{s.repo.url}}</textarea>
                  </span>
               </div> <!-- repositoryInfo -->
               {% endfor %}
            </fieldset>
         </div>{# details #}
      </div> {# moreInfo #}
   </div> {# sourceDetails #}

   {% if s.representations.all %}
   <div id="sourceGallery" class="gallery">
      {% for r in s.representations.all %}
      <div title="{{r.comments}}"><img alt="not found" src="/repr/400/{{r.id}}" /></div>
      {% endfor %}
   </div>
   {% endif %}

     <div style="text-align:right; margin-right:10px">
      <ul style="list-style-type:none">
       <li><a href="#">add</a></li>
       <li style="margin-top:10px"><a href="#">remove</a></li>
      </ul>
     </div>

<div id="info">

 <div class="sourceInfo">
   </div>{# sourceInfo #}


   <div class="sourceActions" style="margin-top:20px">
    <h2>Research to be done</h2>
    <div class="actionsList">
     <ul>
        <li>Not implemented yet</li>
     </ul>
    </div> <!-- actionsList -->
   </div> <!-- sourceActions -->
  </div> <!-- #info -->


  {#  Evidences, below #}

  <div id="extracts">
   <div class="sourcepartInfo">
    {% if s.representations.all %}
      <input type="button" value="grayscale"
          onclick="$('div.scrollable canvas').dragPane('grayscale')"/>
      <input type="button" value="Edges"
          onclick="$('div.scrollable canvas').dragPane('edgeDetect')"/>
      <input type="button" value="Invert"
          onclick="$('div.scrollable canvas').dragPane('invert')"/>
      <input type="button" value="Remove noise"
          onclick="$('div.scrollable canvas').dragPane('removeNoise')"/>
      <div class="scrollable">
         <img alt="Document not found"
              src="/repr/full/{{s.representations.all.0.id}}">
      </div>
    {% else %}
      <div>
         No representation available
      </div>
    {% endif %}

     <h3>Information</h3>
     <div class="onUse">The persons cited in this section are the ones referenced in the source document. They are not related to existing persons in the database. Such links are created in the Conclusions section below.</div>

     <div class="containers">
      <table id="facts" class="sourcepartData" cellspacing="0" cellpadding="0">
        <thead>
           <tr>
              <th>Subject1</th>
              <th>Subject2</th>
              <th>Date</th>
              <th>Place</th>
              <th>Value</th>
              <th>Surety</th>
              <th>Rationale</th>
           </tr>
        </thead>
        <tbody>
           {% for a in s.asserts %}
             {% if a.disproved %}
           <tr class="disproved">
             {% else %}
           <tr>
             {% endif %}

             <td>
                {% if a.subject1_url %}
                <a href="{{a.subject1_url}}">
                {{a.subject1}}
                </a>
                {% else %}
                {{a.subject1}}
                {% endif %}
             </td>
             <td>
                {% if a.subject2_url %}
                <a href="{{a.subject2_url}}">
                {{a.subject2}}
                </a>
                {% else %}
                {{a.subject2}}
                {% endif %}

                {% for pname, pval in a.parts %}
                <span class="char">{{pname}}</span>: {{pval}}<br>
                {% endfor %}
             
             </td>
             <td class="date">{{a.date|default:""}}</td>
             <td>{{a.place|default:""}}</td>
             <td class="assert">{{a.value|linebreaks|default:""}}</td>
             <td>{{a.surety}}</td>
             <td>{{a.rationale|default:""}}</td>
           </tr>
           {% endfor %}
        </tbody>
      </table>
     </div>

     <img src="{{MEDIA_URL}}add.png" alt="add new event">
     <select type="eventType1" style="font-style:italic">
      <option selected>Event</option>
      <option>Birth</option>
      <option>Death</option>
      <option>Marriage</option>
     </select>

     <select type="eventType1" style="font-style:italic">
      <option selected>Characteristic</option>
      <option>Occupation</option>
      <option>Residence</option>
      <option>Education</option>
     </select>

     <select type="eventType1" style="font-style:italic">
      <option selected>Person-&gt;Person</option>
      <option>Father of</option>
      <option>Mother of</option>
      <option>Son of</option>
      <option>Daughter of</option>
      <option>Brother of</option>
      <option>Sister of</option>
      <option>Godfather of</option>
      <option>Godmother of</option>
     </select>

     <select type="eventType1" style="font-style:italic">
      <option selected>Person-&gt;Event</option>
      <option>Aide</option>
      <option>Celebrant</option>
      <option>Clergy</option>
      <option>Familly</option>
      <option>Signed by</option>
      <option>Unknown</option>
      <option selected>Witness</option>
     </select>

     <h3>Evidence</h3>
     <div class="onUse">They represent our interpretation of information we consider relevant to the research question</div>
   </div> <!-- sourcepartDetails -->
  </div> <!-- #evidences -->
</div> {# #tabs #}
</div>
{% endblock contents %}
{% block script %}

$("#facts").dataTable(
  {"sDom": '<"top"lf><"top2"pi>rt',
   "bPaginate": false,
   "bLengthChange": false,
   "bFilter": true,
   "bSort": false,
   "bInfo": false,
   "bAutoWidth": false
  }
);

function hideOrShow(button,selector) {
  $(selector).toggle("fast");
  var b = $(button);
  if (b.text() == "show") b.text ("hide"); else b.text ("show");
}

function getSelectValue (select) {
  return (select.selectedIndex >= 0)
     ? select.options [select.selectedIndex].text
     : select.value;
}

function onTitleChange() {
  parentS = getSelectValue ($("select[name=parentSource]")[0]);
  page    = $("input[name=page]").attr ("value");
  txt = $.sprintf ("%(parent)s, %(page)s", {parent:parentS, page:page});
}

$(document).ready(function(){
  $("#sourceInfo .arrow").click(function() {
     var b = $(this);
     if (b.hasClass("open")) {
        b.removeClass("open").siblings(".details").slideUp();
     } else {
        b.addClass("open").siblings(".details").slideDown();
     }
  });

  new Gallery($("#sourceGallery"), 400);

  //$("div.scrollable img").dragPane();
  //$("#carousel").jcarousel({vertical:false, visible:1, scroll:1, easing:"swing"});
  //$("#carousel img").click(function() {
  //   var src = this.src.split("/");
  //   src[src.length - 2] = "full";
  //   $("div.scrollable canvas").dragPane("setsrc", src.join("/"));
  //});
});
{% endblock script %}
