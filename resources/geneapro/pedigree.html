{% extends "geneapro/base.html" %}
{% block title %}GeneaPro: pedigree{% endblock %}
{% block css %}
.pedigree td.indiv {background:url({{MEDIA_URL}}horiz.png) left center no-repeat}
#pedigreeSVG {width:100%;height:600px;margin:10px 0 10px 0;border:0}
{% endblock css %}
{% block contents %}
<script type="text/javascript">
var boxWidth = 200;
var horizPadding = 20;
var boxHeight = 50;
var vertPadding = 20; {# vertical padding at last gen #}
var sosa=null;
var generations=null;
var children=null;

function onMouseOver (evt) {
  var box = evt.target;
  box.setAttribute ('oldstroke', box.getAttribute ('stroke'));
  box.setAttribute ('stroke', '#555');
  box.setAttribute ('filter','');
}
function onMouseOut (evt) {
  var box = evt.target;
  box.setAttribute ('stroke', box.getAttribute ('oldstroke'));
  box.setAttribute ('filter','url(#shadow)');
}
function ongetJSON (data, status) {
  unsetBusy ();
  sosa = data.sosa;
  generations = data.generations;
  children = data.children;
  drawSOSA ();
}
function getPedigree (id) {
  setBusy ($("#pedigreeSVG"));
  $.getJSON ("{% url pedigree_data %}", {id:id, generations:generations}, ongetJSON);
}
function onClick (evt) {
  var box = evt.target;
  if (box.getAttribute ("sosa") != 1) {
     var num = box.getAttribute ("sosa");
     if (num < 0)
        var id = children[-1 - num].id;
     else
        var id = sosa[num].id;
     getPedigree (id);
  }
}
function onTxtMouseOver (evt) {
  var box = evt.target;
  box.setAttribute ('oldstroke', box.getAttribute ('stroke'));
  box.setAttribute ('stroke', '#888');
  box.setAttribute ('stroke-width', '1');
}
function onTxtMouseOut (evt) {
  var box = evt.target;
  box.setAttribute ('stroke', box.getAttribute ('oldstroke'));
  box.setAttribute ('stroke-width', '0');
}

function drawSOSA() {
   var svg = $('#pedigreeSVG').height ("100%").svg('get');
   svg.clear ();
   var maxBoxes = Math.pow (2,generations-1);{# max boxes at last generation #}
   var totalBoxes = Math.pow (2,generations) - 1; {# geometrical summation #}

   var startX = (children ? boxWidth + horizPadding : 0) + 1;
   var maxWidth = (boxWidth + horizPadding) * generations + startX;
   var maxHeight = boxHeight * maxBoxes + vertPadding * (maxBoxes - 1);

   svg.configure({viewBox:'0 0 ' + maxWidth + " " + maxHeight,
                  preserveAspectRatio:"xMinYMid"},true);
   var filter = svg.filter (svg.defs(), 'shadow', 0, 0);
   svg.filters.gaussianBlur (filter, 'myBlur', {#'SourceAlpha'#}'', 2);
   svg.filters.offset (filter, 'finalBlur', 'myBlur', 3, 3);
   svg.filters.merge (filter, '', ['finalBlur', 'SourceGraphic']);

   var tops = new Array(totalBoxes);

   {# Compute the positions for the last generation #}

   var y = 0;
   for (var index=totalBoxes - maxBoxes; index < totalBoxes; index++) {
      tops[index] = y;
      y += boxHeight + vertPadding;
   }

   {# For the other generations, the boxes are centered relatively to their #}
   {# ancestors in the next gen #}

   for (index = totalBoxes - maxBoxes - 1; index >= 0; index--) {
      tops[index] = (tops [2 * index + 1] + tops [2 * index + 2]) / 2;
   }

   drawBox = function (person, x, y, sosa) {
      if (person && person.sex == "M") {
         var bg = '#D6E0EA';
         var fg = '#9CA3D4';
      } else if (person && person.sex == "F") {
         var bg = '#E9DAF1';
         var fg = '#FF2080';
      } else {
         var bg = '#FFF';
         var fg = '#9CA3D4';
      }
      if (person) {
         svg.rect (x, y, boxWidth, boxHeight,
                  {stroke:fg, fill:bg, filter:"url(#shadow)",
                   sosa:sosa,
                   onclick:'onClick(evt)',
                   onmouseover:'onMouseOver(evt)',
                   onmouseout:'onMouseOut(evt)'});
         var clip = svg.other ('clipPath', {id:'p'+person.id});
         svg.rect (clip, x, y, boxWidth, boxHeight);

        if (person.name) {
          var fontweight = (sosa == 1) ? "bold" : "normal";
          svg.text(x + 4, y + 16,
               svg.createText().string(person.name)
               .span ("b:", {x:x+4, dy:"1em"})
               .span ("d:", {x:x+4, dy:"1em"}),
               {"font-weight":fontweight, "clip-path":"url(#p"+person.id+")",
                "pointer-events":"none"});
        }
      } else {
         svg.rect (x, y, boxWidth, boxHeight,
                  {stroke:fg, fill:bg, "stroke-dasharray":"3",
                   onmouseover:'onMouseOver(evt)',
                   onmouseout:'onMouseOut(evt)'});
      }
   }

   index = 0;
   for (var gen = 0; gen < generations; gen++) {
      var x = (boxWidth + horizPadding) * gen + startX;
      for (var box = Math.pow (2, gen); box >= 1; box--) {
         if (gen < generations - 1) {
            var x2 = x + boxWidth + horizPadding;
            var y1 = tops[2 * index + 1] + boxHeight / 2;
            var y2 = tops[2 * index + 2] + boxHeight / 2;
            svg.path (svg.createPath()
                      .moveTo (x2, y1)
                      .horizTo (x + boxWidth * 0.9)
                      .vertTo (y2)
                      .horizTo (x2),
                      {stroke:'black', fill:'none'});
            if (gen < generations - 1) {
              svg.text (x2, (y1 + y2) / 2 + 4,
                        svg.createText().string ("marriage ?"),
                        {stroke:"black", "stroke-width":0,
                         onmouseover:'onTxtMouseOver(evt)',
                         onmouseout:'onTxtMouseOut(evt)'});
            }
         }
         drawBox (sosa [index + 1], x, tops[index], index + 1);
         index ++;
      }
   }

   {# draw children #}
   if (children) {
      var space = (maxHeight - children.length * boxHeight) 
         / (children.length + 1);
      var y = space;
      for (var c=0; c < children.length; c++) {
         var x2 = x + boxWidth + horizPadding;
         var y2 = tops[2 * index + 2] + boxHeight / 2;
         svg.path (svg.createPath()
                   .moveTo (startX, tops[0] + boxHeight / 2)
                   .horizTo (startX - horizPadding / 2)
                   .vertTo (y + boxHeight / 2)
                   .horizTo (1 + boxWidth),
                   {stroke:'black', fill:'none'});
         drawBox (children [c], 1, y, -1 - c);
         y += boxHeight + space;
      }
   } else {
      console.log ("no children");
   }
}
$(function(){
  $('#pedigreeSVG').svg();
  generations = 4;
  getPedigree (1);
});
</script>
<div id="pedigreeSVG"></div>
{% endblock contents %}

